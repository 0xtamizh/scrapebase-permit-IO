<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrapebase+PermitIO - Advanced Web Scraping Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/marked/marked.min.js" rel="stylesheet">
    <style>
        :root {
            --dark-bg: #0d1117;
            --dark-surface: #161b22;
            --dark-input: #21262d;
            --dark-border: #30363d;
            --dark-text: #c9d1d9;
            --dark-heading: #ffffff;
            --dark-primary: #238636;
            --dark-primary-hover: #2ea043;
            --dark-secondary: #1f6feb;
            --dark-secondary-hover: #388bfd;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        .dark-card {
            background-color: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
        }

        .dark-input {
            background-color: var(--dark-input);
            border: 1px solid var(--dark-border);
            color: var(--dark-text);
        }

        .dark-input:focus {
            border-color: var(--dark-secondary);
            outline: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--dark-surface);
            color: var(--dark-text);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2rem 0;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin: 0 1rem;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--dark-border);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--dark-primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--dark-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--dark-primary-hover);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Copy button */
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.5rem;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 4px;
            color: var(--dark-text);
            cursor: pointer;
        }

        .copy-btn:hover {
            background: var(--dark-border);
        }

        /* Code blocks */
        .code-container {
            position: relative;
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hero section */
        .hero {
            text-align: center;
            padding: 3rem 0;
            max-width: 800px;
            margin: 0 auto;
        }

        .step-container {
            counter-reset: step;
        }

        .step {
            position: relative;
            padding-left: 3rem;
            margin-bottom: 1.5rem;
        }

        .step::before {
            counter-increment: step;
            content: counter(step);
            position: absolute;
            left: 0;
            top: 0;
            width: 2rem;
            height: 2rem;
            background: var(--dark-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0;
            position: relative;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 0 1rem;
        }

        .progress-step::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 2px;
            background: var(--dark-border);
            z-index: 1;
        }

        .progress-step:first-child::before {
            width: 50%;
            left: 50%;
        }

        .progress-step:last-child::before {
            width: 50%;
        }

        .step-number {
            width: 2.5rem;
            height: 2.5rem;
            background: var(--dark-surface);
            border: 2px solid var(--dark-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            position: relative;
            z-index: 2;
        }

        .step-active .step-number {
            background: var(--dark-primary);
            border-color: var(--dark-primary);
        }

        /* Example Domain Buttons */
        .domain-btn {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .domain-btn:hover {
            border-color: var(--dark-secondary);
            background: var(--dark-input);
        }

        .domain-btn::after {
            content: 'Click to scrape';
            position: absolute;
            bottom: -2rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            opacity: 0;
            transition: all 0.2s;
        }

        .domain-btn:hover::after {
            bottom: 0.25rem;
            opacity: 1;
        }

        /* Feature List */
        .feature-list {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .feature-item i {
            color: var(--dark-primary);
        }

        /* Blacklist Domain */
        .blacklist-domain {
            background: #3a1d1d;
            border: 1px solid #5c2626;
            color: #ff9494;
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            display: inline-block;
            cursor: pointer;
        }

        .blacklist-domain:hover {
            background: #4a2424;
        }

        /* Result Toggle */
        .result-toggle {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .result-toggle button {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .result-toggle button.active {
            background: var(--dark-primary);
            border-color: var(--dark-primary);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .progress-steps {
                flex-direction: column;
                gap: 1rem;
                margin: 1rem 0;
            }

            .progress-step {
                width: 100%;
                padding: 0;
            }

            .progress-step::before {
                display: none;
            }

            .step-number {
                margin: 0 auto 0.25rem;
            }

            .grid-cols-2, .grid-cols-3 {
                grid-template-columns: 1fr;
            }

            .domain-btn {
                font-size: 0.9rem;
            }

            .toggle-container {
                flex-direction: column;
                gap: 1rem;
            }

            .feature-list {
                margin: 0.5rem 0;
            }

            .blacklist-domain {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 0.25rem 0;
            }

            #systemStatus {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .modal-content {
                width: 95%;
                padding: 1rem;
            }
        }

        @media (min-width: 640px) and (max-width: 1024px) {
            .grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }

            #systemStatus {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Update existing styles */
        .dark-card {
            @media (max-width: 768px) {
                padding: 1rem;
            }
        }

        .feature-list {
            height: 100%;
        }

        .blacklist-container {
            display: grid;
            gap: 0.5rem;
            @media (min-width: 640px) {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Top Navigation -->
    <nav class="bg-dark-surface border-b border-dark-border p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">Scrapebase+PermitIO</h1>
            <div class="flex items-center gap-4">
                <span id="userTier" class="text-sm font-medium"></span>
                <button id="logoutBtn" class="btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-center text-white">Welcome to Scrapebase+PermitIO</h2>
            
            <div class="toggle-container mb-8">
                <span class="text-lg">User</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="modeToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="text-lg">Admin</span>
            </div>

            <div id="credentialsSection" class="mb-6">
                <div id="userCreds" class="dark-card p-4 mb-4 relative">
                    <p class="font-bold mb-2">User Credentials:</p>
                    <code class="block text-sm">
                        username: newuser<br>
                        password: 2025DEVChallenge
                    </code>
                    <button class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white"
                            onclick="pasteCredentials('user')">
                        <i class="fas fa-paste"></i>
                    </button>
                </div>
                <div id="adminCreds" class="dark-card p-4 relative" style="display: none;">
                    <p class="font-bold mb-2">Admin Credentials:</p>
                    <code class="block text-sm">
                        username: admin<br>
                        password: 2025DEVChallenge
                    </code>
                    <button class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white"
                            onclick="pasteCredentials('admin')">
                        <i class="fas fa-paste"></i>
                    </button>
                </div>
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-2">Username</label>
                    <input type="text" id="username" class="w-full p-2 dark-input rounded">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Password</label>
                    <input type="password" id="password" class="w-full p-2 dark-input rounded">
                </div>
                <button type="submit" class="btn btn-primary w-full">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Progress Steps -->
        <div class="progress-steps mb-12">
            <div class="progress-step step-active">
                <div class="step-number">1</div>
                <div class="step-label">Choose Plan</div>
            </div>
            <div class="progress-step">
                <div class="step-number">2</div>
                <div class="step-label">Select Domain</div>
            </div>
            <div class="progress-step">
                <div class="step-number">3</div>
                <div class="step-label">Configure</div>
            </div>
            <div class="progress-step">
                <div class="step-number">4</div>
                <div class="step-label">Results</div>
            </div>
        </div>

        <!-- Main Interface -->
        <div class="max-w-4xl mx-auto">
            <!-- Plan Selection Toggle -->
            <div class="toggle-container mb-8">
                <span class="text-lg">Basic Plan</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="planToggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="text-lg">Pro Plan</span>
            </div>

            <!-- Domain Selection -->
            <div class="dark-card p-6 mb-6 rounded-xl">
                <h3 class="text-xl font-bold mb-4">Select Domain</h3>
                <p class="text-sm mb-4">Click any example domain to instantly scrape, or enter your own:</p>
                
                <div class="grid grid-cols-3 gap-4 mb-4 sm:grid-cols-2 md:grid-cols-3">
                    <button class="domain-btn" data-domain="example.com">
                        example.com
                        <small class="block text-gray-400">Demo site</small>
                    </button>
                    <button class="domain-btn" data-domain="news.ycombinator.com">
                        news.ycombinator.com
                        <small class="block text-gray-400">Tech news</small>
                    </button>
                    <button class="domain-btn" data-domain="dev.to">
                        dev.to
                        <small class="block text-gray-400">Developer blog</small>
                    </button>
                    <button class="domain-btn" data-domain="github.com">
                        github.com
                        <small class="block text-gray-400">Code hosting</small>
                    </button>
                    <button class="domain-btn" data-domain="stackoverflow.com">
                        stackoverflow.com
                        <small class="block text-gray-400">Q&A site</small>
                    </button>
                    <button class="domain-btn" data-domain="medium.com">
                        medium.com
                        <small class="block text-gray-400">Blog platform</small>
                    </button>
                </div>

                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="customDomain" 
                           placeholder="Or enter custom domain..." 
                           class="w-full sm:flex-1 p-3 dark-input rounded">
                    <button id="scrapeBtn" class="btn btn-primary whitespace-nowrap rounded-lg w-full sm:w-auto">
                        <span id="scrapeBtnText">Start Scraping</span>
                        <span id="scrapeSpinner" class="spinner" style="display: none;"></span>
                    </button>
                </div>

                <div class="mt-4" id="blacklistWarning" style="display: none;">
                    <div class="bg-red-900/50 border border-red-700 rounded-lg p-4">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                            <div class="ml-3">
                                <h4 class="text-red-400 font-semibold">Domain Blacklisted</h4>
                                <p class="text-sm text-red-300">This domain has been blacklisted by administrators and cannot be scraped.</p>
                            </div>
                            <button onclick="document.getElementById('blacklistWarning').style.display='none'" 
                                    class="ml-auto text-red-400 hover:text-red-300">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <p class="text-sm text-gray-400 mb-2">Currently blacklisted domains:</p>
                    <div id="currentBlacklist" class="flex flex-wrap gap-2">
                        <!-- Blacklisted domains will be shown here -->
                    </div>
                </div>
            </div>

            <!-- Pro Features -->
            <div id="proFeatures" class="dark-card p-6 mb-6 rounded-xl" style="display: none;">
                <h3 class="text-xl font-bold mb-4">Pro Features</h3>
                <div class="space-y-4">
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" id="cleanContent" class="form-checkbox">
                        <span>Clean Content</span>
                        <span class="text-sm text-gray-400">(Remove extra spaces and special characters)</span>
                    </label>
                    <label class="flex items-center space-x-3">
                        <input type="checkbox" id="summarizeContent" class="form-checkbox">
                        <span>Summarize Content</span>
                        <span class="text-sm text-gray-400">(AI-powered content summarization)</span>
                    </label>
                </div>
            </div>

            <!-- Results Area -->
            <div id="results" class="dark-card p-6 mb-6 rounded-xl" style="display: none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Results</h3>
                    <button id="copyBtn" class="btn rounded-lg">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>

                <div class="result-toggle">
                    <button id="rawBtn" class="active rounded-lg">Raw Content</button>
                    <button id="renderedBtn" class="rounded-lg">Rendered</button>
                </div>

                <div id="resultsContent" class="code-container rounded-lg">
                    <!-- Results will be inserted here -->
                </div>
                <div id="renderedContent" class="prose prose-invert max-w-none mt-6" style="display: none;">
                    <!-- Rendered content will be inserted here -->
                </div>
            </div>

            <!-- Plan Comparison -->
            <div class="grid grid-cols-2 gap-8 mb-8">
                <div class="feature-list rounded-xl transform hover:scale-105 transition-transform duration-200">
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 p-6 rounded-t-xl border-b border-gray-700">
                        <h3 class="text-2xl font-bold mb-2 flex items-center justify-between">
                            <span>Basic Plan</span>
                            <span class="text-sm px-3 py-1 bg-gray-700 rounded-full">Free</span>
                        </h3>
                        <p class="text-gray-400 text-sm">Perfect for basic scraping needs</p>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="feature-item">
                            <i class="fas fa-check text-green-500"></i>
                            <span>5 requests/minute</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check text-green-500"></i>
                            <span>Basic content scraping</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check text-green-500"></i>
                            <span>Public domains only</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-check text-green-500"></i>
                            <span>Raw content view</span>
                        </div>
                        <div class="feature-item text-gray-500">
                            <i class="fas fa-times"></i>
                            <span>Content cleaning</span>
                        </div>
                        <div class="feature-item text-gray-500">
                            <i class="fas fa-times"></i>
                            <span>AI summarization</span>
                        </div>
                    </div>
                </div>

                <div class="feature-list rounded-xl transform hover:scale-105 transition-transform duration-200 border-2 border-blue-500">
                    <div class="bg-gradient-to-br from-blue-900 to-blue-800 p-6 rounded-t-xl border-b border-blue-700">
                        <h3 class="text-2xl font-bold mb-2 flex items-center justify-between">
                            <span>Pro Plan</span>
                            <span class="text-sm px-3 py-1 bg-blue-700 rounded-full">Premium</span>
                        </h3>
                        <p class="text-blue-300 text-sm">Advanced features for power users</p>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="feature-item">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span>10 requests/minute</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span>Advanced scraping</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span>All domains</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span>Content cleaning</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span>AI summarization</span>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-star text-yellow-500"></i>
                            <span>Priority support</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Interface -->
        <div id="adminInterface" class="max-w-4xl mx-auto mt-8" style="display: none;">
            <div class="dark-card p-6">
                <h3 class="text-xl font-bold mb-4">Domain Management</h3>
                
                <!-- System Status -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold mb-4">System Status</h4>
                    <div id="systemStatus" class="grid grid-cols-3 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                        <!-- Status will be populated dynamically -->
                    </div>
                </div>
                
                <!-- Blacklist Management -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold mb-4">Blacklist Management</h4>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="newBlacklistDomain" 
                               placeholder="Enter domain to blacklist..." 
                               class="w-full sm:flex-1 p-3 dark-input rounded">
                        <button id="addBlacklistBtn" class="btn btn-primary w-full sm:w-auto">
                            Add to Blacklist
                        </button>
                    </div>
                    <div id="blacklistContainer" class="blacklist-container">
                        <!-- Blacklisted domains will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Configuration
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8080'
            : `${window.location.protocol}//${window.location.host}`;
            
        const API_ENDPOINT = `${API_BASE_URL}/api/processLinks`;
        const BLACKLIST_ENDPOINT = `${API_BASE_URL}/api/blacklist`;
        
        // API Keys - Make sure these match your backend configuration
        const API_KEYS = {
            free: '2025DEVChallenge_free',
            pro: '2025DEVChallenge_pro',
            admin: '2025DEVChallenge_admin'
        };

        // Get current API key based on user state
        function getCurrentApiKey() {
            const loginState = JSON.parse(localStorage.getItem('loginState') || '{}');
            if (!loginState) return null;

            if (loginState.isAdmin) {
                return API_KEYS.admin;
            } else if (loginState.isPro) {
                return API_KEYS.pro;
            }
            return API_KEYS.free;
        }

        // Check if user is logged in and has valid API key
        function isLoggedIn() {
            const loginState = JSON.parse(localStorage.getItem('loginState') || '{}');
            const apiKey = getCurrentApiKey();
            return loginState && apiKey;
        }

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const modeToggle = document.getElementById('modeToggle');
        const userCreds = document.getElementById('userCreds');
        const adminCreds = document.getElementById('adminCreds');
        const planToggle = document.getElementById('planToggle');
        const proFeatures = document.getElementById('proFeatures');
        const userTier = document.getElementById('userTier');
        const scrapeBtn = document.getElementById('scrapeBtn');
        const scrapeBtnText = document.getElementById('scrapeBtnText');
        const scrapeSpinner = document.getElementById('scrapeSpinner');
        const results = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        const renderedContent = document.getElementById('renderedContent');
        const copyBtn = document.getElementById('copyBtn');
        const rawBtn = document.getElementById('rawBtn');
        const renderedBtn = document.getElementById('renderedBtn');
        const adminInterface = document.getElementById('adminInterface');

        // Check login state on load
        window.onload = () => {
            const loginState = JSON.parse(localStorage.getItem('loginState') || 'null');
            if (loginState) {
                // Restore login state
                modeToggle.checked = loginState.isAdmin;
                userTier.textContent = loginState.isAdmin ? 'Admin Mode' : 'User Mode';
                adminInterface.style.display = loginState.isAdmin ? 'block' : 'none';
                loginModal.style.display = 'none';
                
                // Restore plan state if saved
                if (loginState.isPro) {
                    planToggle.checked = true;
                    proFeatures.style.display = 'block';
                }

                // Toggle credentials visibility based on mode
                userCreds.style.display = loginState.isAdmin ? 'none' : 'block';
                adminCreds.style.display = loginState.isAdmin ? 'block' : 'none';

                // Load blacklist for all users
                loadBlacklist();
                updateCurrentBlacklist();

                // Load admin features if in admin mode
                if (loginState.isAdmin) {
                    loadSystemStatus();
                }
            } else {
                loginModal.style.display = 'block';
            }
        };

        // Handle mode toggle
        modeToggle.onchange = () => {
            // Toggle credentials visibility
            userCreds.style.display = modeToggle.checked ? 'none' : 'block';
            adminCreds.style.display = modeToggle.checked ? 'block' : 'none';
            
            // Always load blacklist
            loadBlacklist();
            updateCurrentBlacklist();
        };

        // Paste credentials
        function pasteCredentials(type) {
            if (type === 'user') {
                document.getElementById('username').value = 'newuser';
                document.getElementById('password').value = '2025DEVChallenge';
            } else {
                document.getElementById('username').value = 'admin';
                document.getElementById('password').value = '2025DEVChallenge';
            }
        }

        // Handle login
        loginForm.onsubmit = (e) => {
            e.preventDefault();
            const isAdmin = modeToggle.checked;
            const isPro = planToggle.checked;
            
            // Save login state
            localStorage.setItem('loginState', JSON.stringify({
                isAdmin,
                isPro,
                timestamp: new Date().getTime()
            }));

            // Verify API key is available
            const apiKey = getCurrentApiKey();
            if (!apiKey) {
                alert('Error: Unable to initialize API key. Please try logging in again.');
                return;
            }

            loginModal.style.display = 'none';
            userTier.textContent = isAdmin ? 'Admin Mode' : (isPro ? 'Pro Mode' : 'Basic Mode');
            adminInterface.style.display = isAdmin ? 'block' : 'none';

            // Load blacklist after successful login
            loadBlacklist().catch(console.error);
            updateCurrentBlacklist().catch(console.error);
        };

        // Handle plan toggle
        planToggle.onchange = () => {
            proFeatures.style.display = planToggle.checked ? 'block' : 'none';
            updateProgressSteps(1);
            
            // Update stored login state with new plan selection
            const loginState = JSON.parse(localStorage.getItem('loginState') || '{}');
            loginState.isPro = planToggle.checked;
            localStorage.setItem('loginState', JSON.stringify(loginState));
        };

        // Handle domain buttons
        document.querySelectorAll('.domain-btn').forEach(btn => {
            btn.onclick = () => {
                document.getElementById('customDomain').value = btn.dataset.domain;
                updateProgressSteps(2);
                scrapeBtn.click(); // Auto-trigger scrape
            };
        });

        // Handle result view toggle
        rawBtn.onclick = () => {
            rawBtn.classList.add('active');
            renderedBtn.classList.remove('active');
            resultsContent.style.display = 'block';
            renderedContent.style.display = 'none';
        };

        renderedBtn.onclick = () => {
            renderedBtn.classList.add('active');
            rawBtn.classList.remove('active');
            resultsContent.style.display = 'none';
            renderedContent.style.display = 'block';
            // Render markdown
            const content = resultsContent.querySelector('pre').innerText;
            renderedContent.innerHTML = marked.parse(content);
        };

        // Update progress steps
        function updateProgressSteps(step) {
            document.querySelectorAll('.progress-step').forEach((el, index) => {
                if (index < step) {
                    el.classList.add('step-active');
                } else {
                    el.classList.remove('step-active');
                }
            });
        }

        // Handle scrape button
        scrapeBtn.onclick = async () => {
            const domain = document.getElementById('customDomain').value.trim();
            if (!domain) return;
            if(!domain.startsWith('http://')) {
                domain = domain.replace('http://','');
            }
            if(!domain.startsWith('https://')) {
                domain = domain.replace('https://','');
            }
        

            try {
                updateProgressSteps(3);
                scrapeBtn.disabled = true;
                scrapeBtnText.textContent = 'Scraping...';
                scrapeSpinner.style.display = 'inline-block';

                // Get the appropriate API key based on user state
                const loginState = JSON.parse(localStorage.getItem('loginState') || '{}');
                let apiKey;
                if (loginState.isAdmin) {
                    apiKey = API_KEYS.admin;
                } else if (planToggle.checked) {
                    apiKey = API_KEYS.pro;
                } else {
                    apiKey = API_KEYS.free;
                }

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    },
                    body: JSON.stringify({
                        url: `https://${domain}`,
                        advanced: planToggle.checked
                    })
                });

                const data = await response.json();
                
                results.style.display = 'block';

                if (data.success) {
                    updateProgressSteps(4);
                    resultsContent.innerHTML = `<pre class="whitespace-pre-wrap">${data.content}</pre>`;
                    renderedBtn.style.display = planToggle.checked ? 'block' : 'none';
                    
                    // Process text if pro features are enabled
                    if (planToggle.checked && (document.getElementById('cleanContent').checked || document.getElementById('summarizeContent').checked)) {
                        try {
                            const processResponse = await fetch(`${API_BASE_URL}/api/text/process`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'x-api-key': apiKey
                                },
                                body: JSON.stringify({
                                    text: data.content,
                                    clean: document.getElementById('cleanContent').checked,
                                    summarize: document.getElementById('summarizeContent').checked
                                })
                            });

                            const processData = await processResponse.json();
                            
                            if (processData.success) {
                                resultsContent.innerHTML = `<pre class="whitespace-pre-wrap">${processData.content}</pre>`;
                                
                                // Update rendered content if it's currently visible
                                if (renderedContent.style.display === 'block') {
                                    renderedContent.innerHTML = marked.parse(processData.content);
                                }
                            } else {
                                // Show error but keep original content
                                const errorDiv = document.createElement('div');
                                errorDiv.className = 'bg-red-900/50 border border-red-700 rounded p-4 mb-4';
                                errorDiv.innerHTML = `
                                    <div class="flex items-start">
                                        <i class="fas fa-exclamation-circle text-red-500 mt-1"></i>
                                        <div class="ml-3">
                                            <h4 class="text-red-400 font-semibold">Processing Error</h4>
                                            <p class="text-sm text-red-300">${processData.error}: ${processData.details || ''}</p>
                                        </div>
                                    </div>`;
                                resultsContent.insertBefore(errorDiv, resultsContent.firstChild);
                            }
                        } catch (error) {
                            // Show error but keep original content
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'bg-red-900/50 border border-red-700 rounded p-4 mb-4';
                            errorDiv.innerHTML = `
                                <div class="flex items-start">
                                    <i class="fas fa-exclamation-circle text-red-500 mt-1"></i>
                                    <div class="ml-3">
                                        <h4 class="text-red-400 font-semibold">Processing Error</h4>
                                        <p class="text-sm text-red-300">Failed to process text: ${error.message}</p>
                                    </div>
                                </div>`;
                            resultsContent.insertBefore(errorDiv, resultsContent.firstChild);
                        }
                    }
                } else {
                    // Check specifically for blacklisted domain first
                    if (data.permit_decision && data.permit_decision.reason === 'blacklisted_domain') {
                        document.getElementById('blacklistWarning').style.display = 'block';
                        resultsContent.innerHTML = `
                            <div class="bg-red-900/50 border border-red-700 rounded p-4">
                                <div class="flex items-start">
                                    <i class="fas fa-ban text-red-500 mt-1"></i>
                                    <div class="ml-3">
                                        <h4 class="text-red-400 font-semibold">Domain Blacklisted</h4>
                                        <p class="text-sm text-red-300">This domain has been blacklisted by administrators and cannot be scraped.</p>
                                    </div>
                                </div>
                            </div>`;
                    }
                    // Handle rate limit error
                    else if (data.message && data.message.includes('Rate limit exceeded')) {
                        const retryAfter = data.retryAfter || 60;
                        let timeLeft = retryAfter;
                        
                        const updateRateLimitMessage = () => {
                            // Check if user has upgraded to pro
                            if (planToggle.checked) {
                                clearInterval(window.countdownInterval);
                                resultsContent.innerHTML = `
                                    <div class="bg-blue-900/50 border border-blue-700 rounded p-4">
                                        <div class="flex items-start">
                                            <i class="fas fa-arrow-circle-up text-blue-500 mt-1"></i>
                                            <div class="ml-3">
                                                <h4 class="text-blue-400 font-semibold">Pro Plan Active</h4>
                                                <p class="text-sm text-blue-300">You can now make requests with increased rate limits!</p>
                                                <button onclick="scrapeBtn.click()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                                    Try Again Now
                                                </button>
                                            </div>
                                        </div>
                                    </div>`;
                                return;
                            }

                            resultsContent.innerHTML = `
                                <div class="bg-red-900/50 border border-red-700 rounded p-4">
                                    <div class="flex items-start">
                                        <i class="fas fa-exclamation-circle text-red-500 mt-1"></i>
                                        <div class="ml-3">
                                            <h4 class="text-red-400 font-semibold">Rate Limit Exceeded</h4>
                                            <p class="text-sm text-red-300">${data.message}</p>
                                            <p class="text-sm text-red-300 mt-2">You can try again in: ${timeLeft} seconds</p>
                                            <div class="mt-3 p-3 bg-blue-900/50 border border-blue-700 rounded">
                                                <p class="text-sm text-blue-300">
                                                    <i class="fas fa-info-circle"></i>
                                                    Upgrade to Pro for increased rate limits (10 requests/minute)
                                                </p>
                                                <label class="flex items-center mt-2 cursor-pointer">
                                                    <input type="checkbox" 
                                                           class="form-checkbox" 
                                                           ${planToggle.checked ? 'checked' : ''} 
                                                           onchange="planToggle.checked = this.checked; planToggle.dispatchEvent(new Event('change'))">
                                                    <span class="ml-2 text-blue-300">Switch to Pro Plan</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                        };
                        
                        updateRateLimitMessage();
                        
                        // Store interval in window to access it globally
                        if (window.countdownInterval) {
                            clearInterval(window.countdownInterval);
                        }
                        
                        // Start countdown timer
                        window.countdownInterval = setInterval(() => {
                            timeLeft--;
                            if (timeLeft <= 0) {
                                clearInterval(window.countdownInterval);
                                resultsContent.innerHTML = `
                                    <div class="bg-green-900/50 border border-green-700 rounded p-4">
                                        <div class="flex items-start">
                                            <i class="fas fa-check-circle text-green-500 mt-1"></i>
                                            <div class="ml-3">
                                                <h4 class="text-green-400 font-semibold">Rate Limit Reset</h4>
                                                <p class="text-sm text-green-300">You can now make new requests</p>
                                                <button onclick="scrapeBtn.click()" class="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                                                    Try Again
                                                </button>
                                            </div>
                                        </div>
                                    </div>`;
                            } else {
                                updateRateLimitMessage();
                            }
                        }, 1000);
                        
                        renderedContent.innerHTML = '';

                        // Listen for plan toggle changes
                        planToggle.addEventListener('change', updateRateLimitMessage);
                    } else {
                        // Show other error messages (Permit.io decisions, etc.)
                        const errorMessage = data.permit_decision ? 
                            `${data.error}: ${data.details}` :
                            (data.error || data.message || 'Unknown error');
                        
                        resultsContent.innerHTML = `<div class="text-red-500">${errorMessage}</div>`;
                        renderedContent.innerHTML = '';
                    }
                }
            } catch (error) {
                results.style.display = 'block';
                resultsContent.innerHTML = `<div class="text-red-500">Error: ${error.message}</div>`;
            } finally {
                scrapeBtn.disabled = false;
                scrapeBtnText.textContent = 'Start Scraping';
                scrapeSpinner.style.display = 'none';
            }
        };

        // Handle copy button
        copyBtn.onclick = () => {
            const content = resultsContent.innerText;
            navigator.clipboard.writeText(content);
            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy';
            }, 2000);
        };

        // Handle logout
        document.getElementById('logoutBtn').onclick = () => {
            // Clear login state
            localStorage.removeItem('loginState');
            
            // Reset UI
            loginModal.style.display = 'block';
            results.style.display = 'none';
            loginForm.reset();
            planToggle.checked = false;
            proFeatures.style.display = 'none';
            renderedContent.style.display = 'none';
            modeToggle.checked = false;
            userCreds.style.display = 'block';
            adminCreds.style.display = 'none';
            adminInterface.style.display = 'none';
            updateProgressSteps(1);
            
            // Clear any intervals
            clearInterval(window.statusInterval);
        };

        // System Status Management
        async function loadSystemStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                
                // Check if response is valid JSON before parsing
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Server returned non-JSON response. The server might be down or restarting.");
                }
                
                const status = await response.json();
                
                const systemStatus = document.getElementById('systemStatus');
                systemStatus.innerHTML = `
                    <div class="dark-card p-4">
                        <div class="text-2xl font-bold mb-2">${status.queue?.activeRequests || 0}</div>
                        <div class="text-sm text-gray-400">Active Requests</div>
                    </div>
                    <div class="dark-card p-4">
                        <div class="text-2xl font-bold mb-2">${status.queue?.queuedRequests || 0}</div>
                        <div class="text-sm text-gray-400">Queued Requests</div>
                    </div>
                    <div class="dark-card p-4">
                        <div class="text-2xl font-bold mb-2">${status.memory?.heapUsed || '0MB'}</div>
                        <div class="text-sm text-gray-400">Memory Usage</div>
                    </div>
                    <div class="dark-card p-4">
                        <div class="text-2xl font-bold mb-2">${status.uptime || '0'}</div>
                        <div class="text-sm text-gray-400">Uptime</div>
                    </div>
                    <div class="dark-card p-4">
                        <div class="text-2xl font-bold mb-2 ${status.browser?.isActive ? 'text-green-500' : 'text-red-500'}">
                            ${status.browser?.isActive ? 'Active' : 'Inactive'}
                        </div>
                        <div class="text-sm text-gray-400">Browser Status</div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load system status:', error);
                const systemStatus = document.getElementById('systemStatus');
                systemStatus.innerHTML = `
                    <div class="dark-card p-4 col-span-3">
                        <div class="text-red-500 flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Failed to load system status: ${error.message}</span>
                        </div>
                        <button onclick="loadSystemStatus()" class="mt-2 px-3 py-1 bg-red-800 hover:bg-red-700 rounded text-sm">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Admin Blacklist Management
        async function loadBlacklist() {
            if (!isLoggedIn()) {
                throw new Error('Please log in to view blacklist');
            }

            try {
                const apiKey = getCurrentApiKey();
                console.log('Using API Key:', apiKey); // Debug log

                const response = await fetch(BLACKLIST_ENDPOINT, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'x-api-key': apiKey
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                
                const domains = await response.json();
                updateBlacklistUI(domains);
            } catch (error) {
                console.error('Failed to load blacklist:', error);
                const container = document.getElementById('blacklistContainer');
                container.innerHTML = `
                    <div class="bg-red-900/50 border border-red-700 rounded-lg p-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <i class="fas fa-exclamation-circle text-red-500"></i>
                            <span class="text-red-400">${error.message}</span>
                        </div>
                        <button onclick="retryLoadBlacklist()" class="mt-2 px-3 py-1 bg-red-800 hover:bg-red-700 rounded text-sm">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Add retry function
        async function retryLoadBlacklist() {
            try {
                await loadBlacklist();
            } catch (error) {
                console.error('Retry failed:', error);
            }
        }

        // Update current blacklist with better error handling
        async function updateCurrentBlacklist() {
            if (!isLoggedIn()) {
                return; // Silently fail if not logged in
            }

            try {
                const apiKey = getCurrentApiKey();
                console.log('Updating blacklist with API Key:', apiKey); // Debug log

                const response = await fetch(BLACKLIST_ENDPOINT, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'x-api-key': apiKey
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                
                const domains = await response.json();
                const container = document.getElementById('currentBlacklist');
                
                if (!Array.isArray(domains)) {
                    throw new Error('Invalid response format');
                }
                
                if (domains.length === 0) {
                    container.innerHTML = `
                        <span class="text-gray-500 block w-full text-center p-2">
                            No domains blacklisted
                        </span>`;
                    return;
                }
                
                container.innerHTML = domains.map(domain => `
                    <span class="px-3 py-2 bg-red-900/30 border border-red-700 rounded text-sm flex-grow-0 break-all">
                        ${domain}
                    </span>
                `).join('');
            } catch (error) {
                console.error('Failed to update blacklist:', error);
                const container = document.getElementById('currentBlacklist');
                container.innerHTML = `
                    <div class="bg-red-900/50 border border-red-700 rounded-lg p-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <i class="fas fa-exclamation-circle text-red-500"></i>
                            <span class="text-red-400">${error.message}</span>
                        </div>
                        <button onclick="retryLoadBlacklist()" class="mt-2 px-3 py-1 bg-red-800 hover:bg-red-700 rounded text-sm">
                            Retry
                        </button>
                    </div>`;
            }
        }

        // Update blacklist UI
        function updateBlacklistUI(domains) {
            const container = document.getElementById('blacklistContainer');
            const loginState = JSON.parse(localStorage.getItem('loginState') || '{}');
            const isAdmin = loginState.isAdmin;
            
            if (!Array.isArray(domains) || domains.length === 0) {
                container.innerHTML = `
                    <div class="text-gray-400 p-4 text-center">No domains in blacklist</div>
                `;
                return;
            }
            
            container.innerHTML = domains.map(domain => `
                <div class="blacklist-domain group relative p-3 flex items-center justify-between">
                    <span class="font-mono truncate">${domain}</span>
                    ${isAdmin ? `
                        <button onclick="removeDomain('${domain}')" 
                                class="ml-2 text-red-400 hover:text-red-300 transition-opacity"
                                title="Remove from blacklist">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        // Load both blacklist and system status when admin interface is shown
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.id === 'adminInterface' && 
                    mutation.target.style.display === 'block') {
                    loadBlacklist();
                    loadSystemStatus();
                    updateCurrentBlacklist();
                    // Refresh status every 30 seconds
                    clearInterval(window.statusInterval);
                    window.statusInterval = setInterval(() => {
                        loadSystemStatus();
                        updateCurrentBlacklist();
                    }, 30000);
                }
            });
        });

        observer.observe(document.getElementById('adminInterface'), {
            attributes: true,
            attributeFilter: ['style']
        });

        // Add domain to blacklist
        document.getElementById('addBlacklistBtn').onclick = async () => {
            if (!isLoggedIn()) {
                alert('Please log in to manage blacklist');
                return;
            }

            const input = document.getElementById('newBlacklistDomain');
            const domain = input.value.trim().toLowerCase();
            if (!domain) {
                alert('Please enter a domain');
                return;
            }

            // Basic domain validation
            if (!/^[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,}$/.test(domain)) {
                alert('Please enter a valid domain (e.g., example.com)');
                return;
            }

            try {
                const apiKey = getCurrentApiKey();
                const response = await fetch(BLACKLIST_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'x-api-key': apiKey
                    },
                    body: JSON.stringify({ domain })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                input.value = '';
                await loadBlacklist();
                await updateCurrentBlacklist();
            } catch (error) {
                console.error('Failed to add domain:', error);
                alert(`Failed to add domain: ${error.message}`);
            }
        };

        // Remove domain from blacklist
        async function removeDomain(domain) {
            if (!confirm(`Are you sure you want to remove ${domain} from the blacklist?`)) {
                return;
            }

            try {
                const apiKey = getCurrentApiKey();
                const response = await fetch(`${BLACKLIST_ENDPOINT}/${encodeURIComponent(domain)}`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'x-api-key': apiKey
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                await loadBlacklist();
            } catch (error) {
                console.error('Failed to remove domain:', error);
                alert(`Failed to remove domain: ${error.message}`);
            }
        }
    </script>
</body>
</html>